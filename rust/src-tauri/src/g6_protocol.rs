/// USB Protocol implementation for SoundBlaster X G6
/// Based on reverse engineering from soundblaster-x-g6-cli project

use crate::g6_spec::{EffectState, OutputDevice, SmartVolumePreset};

// Protocol constants
const PREFIX: u8 = 0x5a;
const REQUEST_DATA: u16 = 0x1207;
const REQUEST_COMMIT: u16 = 0x1103;
const INTERMEDIATE: u16 = 0x0196;
const PAYLOAD_SIZE: usize = 64;

// Feature hex codes (for toggles)
const FEATURE_SURROUND: u8 = 0x00;
const FEATURE_CRYSTALIZER: u8 = 0x07;
const FEATURE_BASS: u8 = 0x18;
const FEATURE_SMART_VOLUME: u8 = 0x04;
const FEATURE_DIALOG_PLUS: u8 = 0x02;

// Feature hex codes (for sliders = feature + 1)
const FEATURE_SURROUND_SLIDER: u8 = 0x01;
const FEATURE_CRYSTALIZER_SLIDER: u8 = 0x08;
const FEATURE_BASS_SLIDER: u8 = 0x19;
const FEATURE_SMART_VOLUME_SLIDER: u8 = 0x05;
const FEATURE_SMART_VOLUME_SPECIAL: u8 = 0x06;
const FEATURE_DIALOG_PLUS_SLIDER: u8 = 0x03;

// Toggle values
const VALUE_ENABLED: u32 = 0x3f800000; // 1.0f as little-endian u32 (bytes: 00 00 80 3f)
const VALUE_DISABLED: u32 = 0x00000000;

// Smart Volume special values  
const VALUE_SMART_VOLUME_NIGHT: u32 = 0x40000000; // 0.5f (bytes: 00 00 00 40)
const VALUE_SMART_VOLUME_LOUD: u32 = 0x3f800000;  // 1.0f (bytes: 00 00 80 3f)

/// Build a 64-byte USB HID command
fn build_command(request_type: u16, feature: u8, value: u32) -> Vec<u8> {
    let mut command = Vec::with_capacity(PAYLOAD_SIZE);
    
    // Prefix (1 byte)
    command.push(PREFIX);
    
    // Request type (2 bytes, big-endian)
    command.extend_from_slice(&request_type.to_be_bytes());
    
    // Intermediate (2 bytes, big-endian)
    command.extend_from_slice(&INTERMEDIATE.to_be_bytes());
    
    // Feature (1 byte)
    command.push(feature);
    
    // Value (4 bytes, little-endian as per USB spec)
    command.extend_from_slice(&value.to_le_bytes());
    
    // Padding to 64 bytes
    command.resize(PAYLOAD_SIZE, 0x00);
    
    command
}

/// Build command pair (DATA + COMMIT) for a toggle operation
pub fn build_toggle_commands(feature: u8, enabled: bool) -> Vec<Vec<u8>> {
    let value = if enabled { VALUE_ENABLED } else { VALUE_DISABLED };
    
    vec![
        build_command(REQUEST_DATA, feature, value),
        build_command(REQUEST_COMMIT, feature, 0),
    ]
}

/// Build command pair (DATA + COMMIT) for a slider operation
pub fn build_slider_commands(feature: u8, value: u8) -> Vec<Vec<u8>> {
    // Convert 0-100 value to the G6's expected format
    let hex_value = value_to_hex(value);
    
    vec![
        build_command(REQUEST_DATA, feature, hex_value),
        build_command(REQUEST_COMMIT, feature, 0),
    ]
}

/// Convert a 0-100 value to the G6's hex representation
/// The G6 expects IEEE 754 floating point values from 0.0 to 1.0
fn value_to_hex(value: u8) -> u32 {
    // Convert 0-100 to 0.0-1.0 range
    let float_val = (value as f32) / 100.0;
    
    // Convert to IEEE 754 little-endian bytes and then to u32
    let bytes = float_val.to_le_bytes();
    u32::from_le_bytes(bytes)
}

/// Build commands for surround effect
pub fn build_surround_toggle(enabled: bool) -> Vec<Vec<u8>> {
    build_toggle_commands(FEATURE_SURROUND, enabled)
}

pub fn build_surround_slider(value: u8) -> Vec<Vec<u8>> {
    build_slider_commands(FEATURE_SURROUND_SLIDER, value)
}

/// Build commands for crystalizer effect
pub fn build_crystalizer_toggle(enabled: bool) -> Vec<Vec<u8>> {
    build_toggle_commands(FEATURE_CRYSTALIZER, enabled)
}

pub fn build_crystalizer_slider(value: u8) -> Vec<Vec<u8>> {
    build_slider_commands(FEATURE_CRYSTALIZER_SLIDER, value)
}

/// Build commands for bass effect
pub fn build_bass_toggle(enabled: bool) -> Vec<Vec<u8>> {
    build_toggle_commands(FEATURE_BASS, enabled)
}

pub fn build_bass_slider(value: u8) -> Vec<Vec<u8>> {
    build_slider_commands(FEATURE_BASS_SLIDER, value)
}

/// Build commands for smart volume effect
pub fn build_smart_volume_toggle(enabled: bool) -> Vec<Vec<u8>> {
    build_toggle_commands(FEATURE_SMART_VOLUME, enabled)
}

pub fn build_smart_volume_slider(value: u8) -> Vec<Vec<u8>> {
    build_slider_commands(FEATURE_SMART_VOLUME_SLIDER, value)
}

pub fn build_smart_volume_special(preset: SmartVolumePreset) -> Vec<Vec<u8>> {
    let value = match preset {
        SmartVolumePreset::Night => VALUE_SMART_VOLUME_NIGHT,
        SmartVolumePreset::Loud => VALUE_SMART_VOLUME_LOUD,
    };
    
    vec![
        build_command(REQUEST_DATA, FEATURE_SMART_VOLUME_SPECIAL, value),
        build_command(REQUEST_COMMIT, FEATURE_SMART_VOLUME_SPECIAL, 0),
    ]
}

/// Build commands for dialog plus effect  
pub fn build_dialog_plus_toggle(enabled: bool) -> Vec<Vec<u8>> {
    build_toggle_commands(FEATURE_DIALOG_PLUS, enabled)
}

pub fn build_dialog_plus_slider(value: u8) -> Vec<Vec<u8>> {
    build_slider_commands(FEATURE_DIALOG_PLUS_SLIDER, value)
}

/// Parse hex string to bytes
fn hex_to_bytes(hex: &str) -> Vec<u8> {
    (0..hex.len())
        .step_by(2)
        .map(|i| u8::from_str_radix(&hex[i..i + 2], 16).unwrap())
        .collect()
}

/// Build commands for switching to headphones
pub fn build_output_headphones() -> Vec<Vec<u8>> {
    vec![
        hex_to_bytes("5a2c0500040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a2c0101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
    ]
}

/// Build commands for switching to speakers
pub fn build_output_speakers() -> Vec<Vec<u8>> {
    vec![
        hex_to_bytes("5a2c0500020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a2c0101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701961400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301961400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a120701960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
        hex_to_bytes("5a110301960900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"),
    ]
}

/// Build commands for toggling output
pub fn build_output_toggle(current: OutputDevice) -> Vec<Vec<u8>> {
    match current {
        OutputDevice::Headphones => build_output_speakers(),
        OutputDevice::Speakers => build_output_headphones(),
    }
}
